{% extends "base.html" %}

{% block title %}–ü–∞—Ü–∏–µ–Ω—Ç—ã - –ö–∞–±–∏–Ω–µ—Ç –¥–æ–∫—Ç–æ—Ä–∞ –ü–æ–ø–æ–≤–∞{% endblock %}

{% block content %}
<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_patients }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.today_appointments }}</div>
        <div class="stat-label">–ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.new_patients }}</div>
        <div class="stat-label">–ù–æ–≤—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã</div>
    </div>
</div>

<!-- Page Content -->
<div class="page-header">
    <h2 class="page-title">–°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h2>
    
    <!-- Search and Controls -->
    <div class="controls">
        <div class="search-box">
            <input 
                type="text" 
                class="search-input" 
                placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–∞..." 
                id="searchInput"
            >
        </div>
        <button class="btn btn-primary" onclick="showAddPatientModal()">
            + –°–û–ó–î–ê–¢–¨ –ö–ê–†–¢–û–ß–ö–£
        </button>
        <button class="btn btn-secondary" onclick="toggleFilters()">
            üîç –§–ò–õ–¨–¢–†–´
        </button>
    </div>

    <!-- Filters -->
    <div class="filters" id="filtersSection" style="display: none;">
        <button class="filter-btn active" onclick="setFilter('all')">–í—Å–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã</button>
        <button class="filter-btn" onclick="setFilter('new')">–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ</button>
        <button class="filter-btn" onclick="setFilter('active')">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</button>
    </div>
</div>

<!-- Patient List -->
<div class="patient-list">
    <!-- List Header -->
    <div class="list-header">
        <div></div>
        <div>–ü–∞—Ü–∏–µ–Ω—Ç</div>
        <div>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
        <div>–°—Ç–∞—Ç—É—Å</div>
        <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç</div>
    </div>

    <!-- Patient Items -->
    {% for patient in patients %}
    <div class="patient-item" onclick="location.href='/patients/{{ patient.id }}'">
        <div class="status-indicator {{ 'status-new' if patient.status == 'new' else 'status-active' }}"></div>
        <div class="patient-info">
            <div class="patient-name">{{ patient.last_name }} {{ patient.first_name }}</div>
            <div class="patient-phone">{{ patient.phone or '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω' }}</div>
        </div>
        <div class="patient-birthdate">
            {% if patient.birth_date %}
                {{ patient.birth_date.strftime('%d.%m.%Y') }}
            {% else %}
                -
            {% endif %}
        </div>
        {% if patient.status == 'new' %}
        <div class="patient-status">–ù–û–í–ê–Ø</div>
        {% else %}
        <div style="padding: 4px 12px;">-</div>
        {% endif %}
        <div class="patient-last-visit">
            {% if patient.last_visit %}
                {{ patient.last_visit.strftime('%d.%m.%Y') }}
            {% else %}
                -
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="modal">
    <div class="modal-content">
        <h3>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
        <form onsubmit="addPatient(event)">
            <div class="form-row">
                <div class="form-group">
                    <label>–ò–º—è *</label>
                    <input type="text" name="first_name" required>
                </div>
                <div class="form-group">
                    <label>–§–∞–º–∏–ª–∏—è *</label>
                    <input type="text" name="last_name" required>
                </div>
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="date" name="birth_date">
            </div>
            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" name="phone" placeholder="+7 XXX XXX-XX-XX">
            </div>
            <div class="form-group">
                <label>–ò–º—è —Ä–æ–¥–∏—Ç–µ–ª—è</label>
                <input type="text" name="parent_name">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddPatientModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏
function showAddPatientModal() {
    document.getElementById('addPatientModal').style.display = 'flex';
}

function closeAddPatientModal() {
    document.getElementById('addPatientModal').style.display = 'none';
}

function toggleFilters() {
    const filters = document.getElementById('filtersSection');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function setFilter(filter) {
    // –û–±–Ω–æ–≤–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    console.log('Filter:', filter);
}

async function addPatient(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const patientData = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/api/patients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(patientData)
        });
        
        if (response.ok) {
            closeAddPatientModal();
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞');
    }
}

function viewPatient(patientId) {
    // –í –±—É–¥—É—â–µ–º - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–∞—Ü–∏–µ–Ω—Ç–∞
    alert('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ID: ' + patientId);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('addPatientModal');
    if (event.target === modal) {
        closeAddPatientModal();
    }
}
</script>
{% endblock %}
